#!/bin/sh

DISTRO="$(cat /etc/system-release)"
PM_install="sudo dnf install -y -q "
PIP_install="sudo pip install "
dotfiles_home="$(dirname $0)"
dotfiles_home="$(realpath $dotfiles_home)"
VERBOSE="no"
# List of RPMs to be installed
#TODO add build essential ?
BASE_RPM="byobu screen vim git python-pip python3-pip"

function cleanup {
	# Perform program exit housekeeping
	echo "Exiting ..."
	exit
}
trap cleanup SIGHUP SIGINT SIGTERM

# installing a few bash functions I often use
mkdir -p ${HOME}/bin
ln -sf $(pwd)/bash/base_functions.conf ${HOME}/bin/
source ./bash/base_functions.conf

verbose "Current system release is : $DISTRO"

# this is because the package manager
if [ -z "$(echo $DISTRO | grep -i fedora)" ]; then
	exit_err "For now, the only Linux distro supported is Fedora... Sorry !"
fi
# If we are on an older Fedora release use YUM instead of DNF
if [ -z "$(which dnf)" ]; then
	PM="sudo yum install -y -q"
fi

if [ $(whoami) = "root" ]; then
	exit_err "This must NOT be run as root !"
fi

if [ -z "$(groups | grep wheel)" ]; then
	exit_err "$(whoami) is not in wheel group try : 'sudo usermod -aG wheel $(whoami)'"
fi

# Warn the user this is dangerous
read -p "This will delete all your old rcfiles and install packages Continue ? [y/n] " rc
if [ $rc != "y" ]; then
	exit_err "Exiting upon your request !"
fi

# install needed packages
verbose "Installing base packages ..."
$PM_install $BASE_RPM
verbose "Done"

# link custom dotfiles
ln -sf $(pwd)/bashrc ${HOME}/.bashrc
ln -sf $(pwd)/screenrc ${HOME}/.screenrc
ln -sf $(pwd)/screen/screen_skins ${HOME}/.screen_skins
# Setting up vim
ln -sf $(pwd)/vimrc ${HOME}/.vimrc
git clone https://github.com/gmarik/Vundle.vim.git ${HOME}/.vim/bundle/Vundle.vim
# Installing bundles...
vim +PluginInstall +qall

# Installing bash-autocomplete scripts
verbose "Installing competions..."
for file in $dotfiles_home/autocompletion/*; do
	verbose "Deploying $file"
	cp $file /etc/bash_completion.d/
done
verbose "\`Done"

# setup gnome-terminal
verbose "Installing fonts ..."
$PM_install terminus-fonts terminus-fonts-console
verbose "Editing gnome-terminal settings..."
dconf load /org/gnome/terminal/legacy/ < $dotfiles_home/terminal_settings
verbose "\`Done"

#Install VIMPAGER
verbose "Installing Vimpager..."
cd $dotfiles_home
# Get dependencies
$PM_install pandoc
git clone https://github.com/rkitover/vimpager.git
cd vimpager
sudo make install
# TODO Edit pager in bashrc
 #export PAGER=/usr/local/bin/vimpager
 #alias less=$PAGER
 #alias zless=$PAGER
cd $dotfiles_home
verbose "| Cleaning up..."
rm -rf vimpager
verbose " \`Done"


# Installing Cheat tool
verbose "Installing cheat tool"
$PIP_install cheat
rm -rf ${HOME}/.cheat
ln -sf $(pwd)/cheat ${HOME}/.cheat
verbose "\`Done"

# vim:set cc=80 :
